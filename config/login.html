<html>
<meta name="google-signin-client_id" content="539699277901-buh78f048405grejogqbrskj233rt0d0.apps.googleusercontent.com">
<script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
<script type='text/javascript' src='./common/util.js'></script>
<div id="google-signin2" class="g-signin2"></div>
<!-- <a href="#" onclick="signOut();">Sign out</a> -->
<script>
  function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function () {
      console.log('User signed out.');
    });
  }

  function renderButton() {
    gapi.signin2.render('google-signin2', {
      'scope': 'profile email',
      'width': 240,
      'height': 50,
      'longtitle': true,
      'theme': 'dark',
      'onsuccess': onSignIn,
      'onfailure': onFailure
    });
  }

  function onFailure(error) {
    console.log(error);
  }
</script>
<script>
function deleteCookies() {
   var allcookies = document.cookie.split(";");
   for (var i = 0; i < allcookies.length; i++) {
        var cookie = allcookies[i];
        var eqPos = cookie.indexOf("=");
        var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;";
    }
}

function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
};

// google's jwk is here: https://www.googleapis.com/oauth2/v3/certs
function randomString(length) {
    var bytes = new Uint8Array(length);
    var random = window.crypto.getRandomValues(bytes);
    var result = [];
    var charset = '0123456789ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz-._~'
    random.forEach(function (c) {
        result.push(charset[c % charset.length]);
    });
    return result.join('');
}
function getUrlParam(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&#]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}
function onSignIn(googleUser) {
  // don't if we're logging out
  if (getUrlParam("logout")){
    removeUserConsentAcceptance(getUserId())
    signOut()
    deleteCookies()
    console.log("logging out")
    window.location.href = "./login.html";
  } else {
  var id_token = googleUser.getAuthResponse().id_token;
  console.info(id_token)
  // trade for camic token
  var cookie_name = "token" // "token" is expected by elevate router
  var base_deployment_url = window.location.toString().split("/").slice(0,-1).join("/")
  var redirect_uri = base_deployment_url + "/login.html"
  var default_redirect = base_deployment_url + "/apps/table.html"
  var state
  if (getUrlParam("state"))
  {
    state = decodeURIComponent(getUrlParam("state"))
  }
  if (!state){
    state = default_redirect
  }
  if (id_token){
    document.cookie = cookie_name + "=" + id_token;
    fetch("./auth/Token/check",
    {headers: {
        'Authorization': "Bearer " + id_token
     }}
    ).then(x=>x.json()).then(x=>{
      console.log("{id provider", id_token)
      console.log("{auth service}", x)
      if (x.hasOwnProperty('token')){
        document.cookie = cookie_name + "=" + x.token;
        let token_data = parseJwt(x.token)
        if (token_data.attrs && token_data.attrs.length >= 1){
          window.location = "./apps/landing/landing.html"
        } else {
          window.location = "./apps/landing/crowd.html"
        }
      } else {
        window.alert("User not added")
        window.location = "./apps/signup/signup"
      }
    })
  }
  }
  
}
</script>
<html>
